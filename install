#!/usr/bin/env bash
# =============================================================================
# LeakOS Linux Installer (ZENITY + BOOTABLE FIX)
# =============================================================================

set -euo pipefail

# =============================================================================
# ENV FIX
# =============================================================================
export GTK_THEME=Adwaita
export NO_AT_BRIDGE=1
export XDG_DATA_DIRS=/usr/share:/usr/share/icons

# =============================================================================
# ROOT CHECK
# =============================================================================
if [ "$(id -u)" -ne 0 ]; then
    zenity --error --title="LeakOS Installer" \
        --text="Installer harus dijalankan sebagai root!"
    exit 1
fi

# =============================================================================
# DEPENDENCY CHECK
# =============================================================================
for cmd in zenity lsblk cfdisk mkfs.ext4 rsync grub-install grub-mkconfig; do
    command -v "$cmd" >/dev/null 2>&1 || {
        zenity --error --text="Dependency hilang: $cmd"
        exit 1
    }
done

# =============================================================================
# BANNER
# =============================================================================
zenity --info --title="LeakOS Installer" --width=420 --text="
LeakOS Linux Installer

‚ö†Ô∏è PERINGATAN:
‚Ä¢ SEMUA DATA AKAN DIHAPUS
‚Ä¢ Gunakan mesin kosong / VM

Klik OK untuk lanjut
"

# =============================================================================
# DISK SELECT
# =============================================================================
TARGET_DISK=$(zenity --list \
    --title="Pilih Disk Target" \
    --radiolist \
    --column "Pilih" --column "Disk" --column "Ukuran" \
    $(lsblk -dno NAME,SIZE,TYPE | awk '$3=="disk"{print "FALSE /dev/"$1" "$2}') \
    --width=500 --height=300) || exit 1

[ -b "$TARGET_DISK" ] || exit 1

# =============================================================================
# CONFIRM
# =============================================================================
zenity --question --title="Konfirmasi" --text="
Disk: $TARGET_DISK
SEMUA DATA AKAN DIHAPUS

Lanjutkan?" || exit 0

# =============================================================================
# PARTITIONING
# =============================================================================
zenity --info --title="Partisi" --text="
UEFI:
- GPT
- 512M EFI System
- Sisa Linux filesystem

BIOS:
- DOS
- 1 Linux filesystem
"

cfdisk "$TARGET_DISK"
partprobe "$TARGET_DISK"
sleep 2

# =============================================================================
# DETECT PARTITIONS
# =============================================================================
EFI_PART=""
ROOT_PART=""

while read -r name fstype size; do
    if [[ "$fstype" == "vfat" ]] || [[ "$size" == "512M" ]]; then
        EFI_PART="/dev/$name"
    else
        ROOT_PART="/dev/$name"
    fi
done < <(lsblk -ln -o NAME,FSTYPE,SIZE "$TARGET_DISK" | tail -n +2)

[ -b "$ROOT_PART" ] || {
    zenity --error --text="Root partition tidak ditemukan"
    exit 1
}

# =============================================================================
# USER INPUT
# =============================================================================
USERNAME=$(zenity --entry --title="User" --text="Username" --entry-text="leakos") || exit 1
HOSTNAME=$(zenity --entry --title="Hostname" --text="Hostname" --entry-text="leakos") || exit 1
PASSWORD=$(zenity --password --title="Password") || exit 1
PASSWORD2=$(zenity --password --title="Konfirmasi") || exit 1

[ "$PASSWORD" = "$PASSWORD2" ] || {
    zenity --error --text="Password tidak cocok"
    exit 1
}

# =============================================================================
# INSTALL
# =============================================================================
(
echo 5;  echo "# Format root"
mkfs.ext4 -F "$ROOT_PART" >/dev/null

echo 15; echo "# Mount root"
mkdir -p /mnt/leakos
mount "$ROOT_PART" /mnt/leakos

if [ -n "$EFI_PART" ] && [ -d /sys/firmware/efi ]; then
    echo 20; echo "# Setup EFI"
    mkfs.fat -F32 "$EFI_PART" >/dev/null
    mkdir -p /mnt/leakos/boot/efi
    mount "$EFI_PART" /mnt/leakos/boot/efi
fi

echo 35; echo "# Copy system"
rsync -aHAX / /mnt/leakos \
--exclude={/dev/*,/proc/*,/sys/*,/run/*,/tmp/*,/mnt/*,/media/*,/lost+found}

# =============================================================================
# üî• KERNEL FIX (INI YANG SEBELUMNYA HILANG)
# =============================================================================
echo 55; echo "# Install kernel"
mkdir -p /mnt/leakos/boot

cp -v /boot/vmlinuz* /mnt/leakos/boot/ 2>/dev/null || true
cp -v /boot/initramfs* /mnt/leakos/boot/ 2>/dev/null || true
cp -v /run/media/*/boot/vmlinuz* /mnt/leakos/boot/ 2>/dev/null || true
cp -v /run/media/*/boot/initramfs* /mnt/leakos/boot/ 2>/dev/null || true

ls /mnt/leakos/boot/vmlinuz* >/dev/null 2>&1 || {
    zenity --error --text="Kernel tidak ditemukan!\nInstaller dihentikan."
    exit 1
}

# =============================================================================
# SYSTEM SETUP
# =============================================================================
echo 70; echo "# Setup system"
mount --bind /dev  /mnt/leakos/dev
mount --bind /proc /mnt/leakos/proc
mount --bind /sys  /mnt/leakos/sys

chroot /mnt/leakos /bin/bash <<EOF
echo "$HOSTNAME" > /etc/hostname
useradd -m -G wheel -s /bin/bash $USERNAME
echo "$USERNAME:$PASSWORD" | chpasswd
echo "%wheel ALL=(ALL) ALL" > /etc/sudoers.d/wheel
EOF

# =============================================================================
# GRUB
# =============================================================================
echo 85; echo "# Install GRUB"
if [ -n "$EFI_PART" ] && [ -d /sys/firmware/efi ]; then
    chroot /mnt/leakos grub-install \
        --target=x86_64-efi \
        --efi-directory=/boot/efi \
        --bootloader-id=LeakOS
else
    chroot /mnt/leakos grub-install \
        --target=i386-pc "$TARGET_DISK"
fi

chroot /mnt/leakos grub-mkconfig -o /boot/grub/grub.cfg

echo 100; echo "# Selesai"
) | zenity --progress --title="LeakOS Installer" --percentage=0 --auto-close

# =============================================================================
# FINISH
# =============================================================================
sync
umount -R /mnt/leakos || true

zenity --info --title="LeakOS Installer" \
--text="Instalasi selesai!\nSilakan reboot."

exit 0
